<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MEDU Case Vault - Medical Education Department</title>
  <style>
    /* Reset & Base */
    *, *::before, *::after {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      padding: 0;
      font-family: 'Poppins', 'Roboto', sans-serif;
      background: linear-gradient(135deg, #1e3c72, #2a5298);
      color: #e0eaff;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    a {
      color: #a8c0ff;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
    h1, h2, h3 {
      margin: 0 0 0.4rem 0;
    }
    h1 {
      font-weight: 700;
      font-size: 2.5rem;
      letter-spacing: 1.2px;
      text-shadow: 0 0 8px rgba(255, 255, 255, 0.3);
    }
    h2 {
      font-weight: 600;
      font-size: 1.6rem;
      margin-top: 1rem;
    }
    h3 {
      font-weight: 500;
      font-size: 1.2rem;
    }

    /* Container */
    #app, #loginPage, #memberLoginPage {
      max-width: 1300px;
      margin: 1rem auto;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 16px;
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.4), inset 0 0 0 1px rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    /* Header */
    header {
      background: rgba(10, 30, 80, 0.85);
      padding: 1.2rem 2rem;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    header h1 {
      color: #a8c0ff;
    }
    header small {
      color: #89aaffcc;
      font-weight: 400;
      font-size: 0.9rem;
    }
    #darkModeToggle, #logoutBtn {
      cursor: pointer;
      background: #3458f0;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 12px;
      color: white;
      font-weight: 600;
      user-select: none;
      transition: background 0.3s ease;
      margin-left: 0.5rem;
    }
    #darkModeToggle:hover, #logoutBtn:hover {
      background: #567dff;
    }

    /* Layout */
    main {
      display: flex;
      flex-grow: 1;
      min-height: 600px;
    }

    /* Sidebar */
    nav.sidebar {
      width: 260px;
      background: rgba(20, 40, 90, 0.8);
      border-right: 1.5px solid #4f6ef7aa;
      display: flex;
      flex-direction: column;
      padding: 1rem 1rem 2rem 1rem;
      overflow-y: auto;
    }
    nav.sidebar h2 {
      margin-bottom: 1rem;
      text-align: center;
      color: #b0c7ff;
      text-shadow: 0 0 5px rgba(255, 255, 255, 0.25);
    }
    nav.sidebar a {
      padding: 0.7rem 1rem;
      margin-bottom: 0.5rem;
      color: #abc2ff;
      border-radius: 10px;
      font-weight: 500;
      display: block;
      transition: background-color 0.3s ease;
    }
    nav.sidebar a.active, nav.sidebar a:hover {
      background: #4a67f5;
      color: #fff;
      box-shadow: 0 0 8px #5b78ffcc;
    }

    /* Content */
    section.content {
      flex-grow: 1;
      background: rgba(255, 255, 255, 0.05);
      padding: 2rem 3rem;
      overflow-y: auto;
      position: relative;
    }
    section.content h2 {
      margin-bottom: 1rem;
      border-bottom: 2px solid #678dffcc;
      padding-bottom: 0.3rem;
      text-shadow: 0 0 10px rgba(104, 141, 255, 0.6);
    }

    /* Table */
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0 12px;
      font-size: 0.95rem;
    }
    thead tr {
      background: #3951b3cc;
      text-align: left;
      color: #d0dbff;
      font-weight: 600;
    }
    th, td {
      padding: 12px 18px;
    }
    tbody tr {
      background: rgba(255, 255, 255, 0.07);
      box-shadow: inset 0 0 0 1px #4c63d2aa;
      border-radius: 10px;
      transition: background-color 0.3s ease;
      cursor: pointer;
    }
    tbody tr:hover {
      background-color: #4560e5bb;
    }

    /* Status badges */
    .badge {
      padding: 0.25rem 0.7rem;
      border-radius: 12px;
      font-weight: 600;
      font-size: 0.85rem;
      color: white;
      text-align: center;
      display: inline-block;
      min-width: 60px;
    }
    .badge.solved, .badge.resolved {
      background: #34c759;
      box-shadow: 0 0 10px #32d858aa;
    }
    .badge.open {
      background: #ff3b30;
      box-shadow: 0 0 10px #ff4a3daa;
    }
    .badge.pending, .badge.in-progress {
      background: #ffcc00;
      color: #222;
      box-shadow: 0 0 10px #ffdd44aa;
    }

    /* Progress bar */
    .progress-bar-container {
      width: 100%;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      overflow: hidden;
      margin: 1rem 0;
      box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.3);
    }
    .progress-bar {
      height: 20px;
      background: linear-gradient(90deg, #34c759, #4a83ff);
      transition: width 0.5s ease;
      text-align: right;
      padding-right: 10px;
      color: white;
      font-weight: 600;
      font-size: 0.9rem;
      line-height: 20px;
    }

    /* Filters and search */
    .filters {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
    }
    .filters label {
      font-weight: 600;
      color: #aac3ffdd;
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }
    select, input[type="search"], input[type="text"], input[type="password"] {
      padding: 0.35rem 0.7rem;
      border-radius: 8px;
      border: none;
      font-size: 1rem;
      outline-offset: 2px;
      outline-color: #799cff;
      background: rgba(255, 255, 255, 0.15);
      color: #e0eaff;
      transition: background-color 0.3s ease;
    }
    select:hover, input[type="search"]:hover, input[type="text"]:hover, input[type="password"]:hover,
    select:focus, input[type="search"]:focus, input[type="text"]:focus, input[type="password"]:focus {
      background: rgba(255, 255, 255, 0.3);
    }

    /* Sorting buttons */
    .sort-btn {
      background: transparent;
      border: none;
      color: #abc2ff;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.9rem;
      margin-left: 6px;
      transition: color 0.3s ease;
      user-select: none;
    }
    .sort-btn:hover {
      color: #f0f8ff;
    }

    /* Modal styling */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    .modal.active {
      display: flex;
      animation: fadeIn 0.3s ease forwards;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .modal-content {
      background: rgba(255, 255, 255, 0.07);
      border-radius: 20px;
      padding: 2rem 2.5rem;
      max-width: 700px;
      width: 90%;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.7), inset 0 0 0 1px rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      color: #e1eaff;
      overflow-y: auto;
      max-height: 80vh;
      position: relative;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }
    .modal-header h2 {
      font-size: 1.8rem;
      color: #a5b8ff;
    }
    .close-btn {
      background: none;
      border: none;
      font-size: 1.8rem;
      color: #a5b8ff;
      cursor: pointer;
      font-weight: 700;
      transition: color 0.3s ease;
    }
    .close-btn:hover {
      color: #fff;
    }
    .modal-section {
      margin-bottom: 1.4rem;
    }
    .modal-section h3 {
      font-size: 1.2rem;
      color: #a5b8ff;
      margin-bottom: 0.5rem;
    }
    .modal-section p, .modal-section textarea, .modal-section input, .modal-section select {
      font-size: 1rem;
      line-height: 1.5;
      background: rgba(255, 255, 255, 0.1);
      border: none;
      border-radius: 12px;
      padding: 0.8rem 1rem;
      color: #d9e3ff;
      resize: vertical;
      min-height: 80px;
      width: 100%;
      font-family: 'Poppins', sans-serif;
      box-shadow: inset 0 0 5px rgba(255, 255, 255, 0.2);
    }
    .modal-section textarea {
      min-height: 120px;
    }
    .modal-section select {
      min-height: auto;
    }

    /* Forms */
    form.new-case-form, form.feedback-form, form.edit-case-form, form.login-form, form.task-form, form.ticket-form {
      max-width: 650px;
      margin: 0 auto;
    }
    form label {
      font-weight: 600;
      display: block;
      margin-bottom: 0.3rem;
      color: #b8c4ff;
    }
    form input[type="text"], form input[type="password"], form select, form textarea {
      width: 100%;
      padding: 0.6rem 1rem;
      margin-bottom: 1.2rem;
      border-radius: 10px;
      border: none;
      background: rgba(255, 255, 255, 0.15);
      color: #e0eaff;
      font-size: 1rem;
      transition: background-color 0.3s ease;
      box-shadow: inset 0 0 7px rgba(255, 255, 255, 0.15);
    }
    form input[type="text"]:focus, form input[type="password"]:focus, form select:focus, form textarea:focus {
      background: rgba(255, 255, 255, 0.3);
      outline: none;
    }
    form button.submit-btn, form button.delete-btn {
      background: #3468f0;
      border: none;
      color: white;
      padding: 0.8rem 1.6rem;
      font-weight: 700;
      font-size: 1.1rem;
      border-radius: 16px;
      cursor: pointer;
      box-shadow: 0 0 12px #527ff6bb;
      transition: background-color 0.3s ease;
      margin-right: 0.5rem;
    }
    form button.submit-btn:hover {
      background: #4a83ff;
    }
    form button.delete-btn {
      background: #ff3b30;
      box-shadow: 0 0 12px #ff4a3daa;
    }
    form button.delete-btn:hover {
      background: #ff5550;
    }

    /* Star rating */
    .star-rating {
      display: flex;
      gap: 0.3rem;
      margin-bottom: 1rem;
    }
    .star-rating input {
      display: none;
    }
    .star-rating label {
      font-size: 1.5rem;
      color: #ccc;
      cursor: pointer;
      transition: color 0.3s ease;
    }
    .star-rating label:hover,
    .star-rating label:hover ~ label,
    .star-rating input:checked ~ label {
      color: #ffcc00;
    }

    /* Notification Toast */
    .notification {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 1rem 1.5rem;
      color: #e0eaff;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(10px);
      z-index: 10000;
      display: none;
      animation: slideIn 0.3s ease forwards;
    }
    .notification.success {
      background: rgba(52, 199, 89, 0.2);
    }
    .notification.error {
      background: rgba(255, 59, 48, 0.2);
    }
    .notification.active {
      display: block;
    }
    @keyframes slideIn {
      from { transform: translateY(100px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    /* Login Page */
    .login-container {
      max-width: 400px;
      margin: 5rem auto;
      padding: 2rem;
    }
    .login-container h2 {
      text-align: center;
      margin-bottom: 1.5rem;
    }
    .error-message {
      color: #ff4a3daa;
      font-size: 0.9rem;
      margin-bottom: 1rem;
      text-align: center;
      display: none;
    }
    .error-message.active {
      display: block;
    }

    /* Dashboard Stats */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }
    .stat-card {
      background: rgba(255, 255, 255, 0.07);
      border-radius: 12px;
      padding: 1rem;
      text-align: center;
      box-shadow: inset 0 0 0 1px #4c63d2aa;
    }
    .stat-card h3 {
      font-size: 1.1rem;
      color: #aac3ff;
    }
    .stat-card p {
      font-size: 1.5rem;
      font-weight: 700;
      color: #fff;
      margin: 0.5rem 0 0;
    }

    /* Responsive */
    @media (max-width: 900px) {
      main {
        flex-direction: column;
      }
      nav.sidebar {
        width: 100%;
        order: 2;
        border-right: none;
        border-bottom: 1.5px solid #4f6ef7aa;
        padding: 0.5rem 0.7rem;
        display: flex;
        overflow-x: auto;
      }
      nav.sidebar a {
        flex: 1 0 auto;
        text-align: center;
        padding: 0.6rem 1rem;
        margin-bottom: 0;
        border-radius: 0;
      }
      section.content {
        order: 1;
        padding: 1.5rem 1.5rem 3rem 1.5rem;
      }
      table thead {
        display: none;
      }
      table, tbody, tr, td {
        display: block;
        width: 100%;
      }
      tbody tr {
        margin-bottom: 1rem;
        background: rgba(255, 255, 255, 0.07);
        box-shadow: inset 0 0 0 1px #4c63d2aa;
        border-radius: 10px;
        padding: 1rem;
      }
      tbody tr:hover {
        background: #4560e5bb;
      }
      tbody td {
        padding: 8px 6px;
        text-align: right;
        position: relative;
        padding-left: 50%;
        font-size: 0.9rem;
      }
      tbody td::before {
        content: attr(data-label);
        position: absolute;
        left: 16px;
        top: 50%;
        transform: translateY(-50%);
        font-weight: 600;
        color: #aac3ffdd;
        white-space: nowrap;
        font-size: 0.9rem;
        text-transform: uppercase;
      }
      .modal-content {
        width: 95%;
        padding: 1.5rem;
      }
      .stats-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- Admin Login Page -->
  <div id="loginPage" style="display: none;">
    <div class="login-container">
      <h2>Admin Login</h2>
      <div class="error-message" id="loginError">Invalid username or password</div>
      <form class="login-form" aria-label="Admin login form">
        <label for="username">Username</label>
        <input type="text" id="username" name="username" required placeholder="Enter username" autocomplete="username" />
        <label for="password">Password</label>
        <input type="password" id="password" name="password" required placeholder="Enter password" autocomplete="current-password" />
        <button type="submit" class="submit-btn">Login</button>
        <p style="text-align: center; margin-top: 1rem;">
          <a href="#" id="switchToMemberLogin">Login as Member</a>
        </p>
      </form>
    </div>
  </div>

  <!-- Member Login Page -->
  <div id="memberLoginPage" style="display: none;">
    <div class="login-container">
      <h2>Member Login</h2>
      <div class="error-message" id="memberLoginError">Please enter a valid name</div>
      <form class="login-form" aria-label="Member login form">
        <label for="memberName">Name</label>
        <input type="text" id="memberName" name="memberName" required placeholder="Enter your name" autocomplete="name" />
        <button type="submit" class="submit-btn">Login</button>
        <p style="text-align: center; margin-top: 1rem;">
          <a href="#" id="switchToAdminLogin">Login as Admin</a>
        </p>
      </form>
    </div>
  </div>

  <!-- Main App -->
  <div id="app" style="display: none;">
    <header>
      <div>
        <h1>MEDU Case Vault</h1>
        <small>By Luna.C.Everly | Medical Education Department</small>
      </div>
      <div>
        <button id="darkModeToggle" aria-label="Toggle dark mode">🌙 Dark Mode</button>
        <button id="logoutBtn" aria-label="Logout">Logout</button>
      </div>
    </header>

    <main>
      <nav class="sidebar" aria-label="Primary">
        <h2>Navigation</h2>
        <a href="#" class="nav-link active" data-section="dashboard">Dashboard</a>
        <a href="#" class="nav-link" data-section="cases">Cases</a>
        <a href="#" class="nav-link" data-section="newcase">New Case</a>
        <a href="#" class="nav-link" data-section="tickets">Tickets</a>
        <a href="#" class="nav-link" data-section="tasks">Tasks</a>
        <a href="#" class="nav-link" data-section="feedback">Feedback</a>
        <a href="#" class="nav-link" data-section="members">Members</a>
        <a href="#" class="nav-link" data-section="about">About</a>
      </nav>
      <section class="content" id="content"></section>
    </main>
  </div>

  <!-- Case/Ticket/Task Detail/Edit Modal -->
  <div class="modal" id="itemModal" aria-hidden="true" role="dialog" aria-labelledby="modalTitle">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle">Details</h2>
        <button class="close-btn" aria-label="Close modal" id="modalClose">×</button>
      </div>
      <div id="modalBody"></div>
    </div>
  </div>

  <!-- Notification Toast -->
  <div class="notification" id="notification"></div>

  <script>
    (() => {
      // Initial data
      const initialCases = [
        {
          id: "MEDU-001",
          title: "Pediatric Ethical Dilemma",
          type: "Ethical",
          status: "Open",
          creator: "Dr. Smith",
          assignedTo: "Dr. Smith",
          lastUpdated: "2025-07-05",
          symptoms: "Parental refusal of treatment in a minor",
          history: "12-year-old child with severe asthma exacerbation",
          labResults: "Blood gas normal, O2 sat 92%",
          diagnosis: "Acute asthma attack with refusal of intervention",
          outcome: "Pending parental consent",
          notes: ""
        },
        {
          id: "MEDU-002",
          title: "ER Trauma Case",
          type: "Emergency",
          status: "Solved",
          creator: "Dr. Lee",
          assignedTo: "Dr. Lee",
          lastUpdated: "2025-06-25",
          symptoms: "Severe head trauma, unconscious",
          history: "Hit by car 1 hour ago",
          labResults: "CT shows subdural hematoma",
          diagnosis: "Acute subdural hematoma with midline shift",
          outcome: "Surgical evacuation successful",
          notes: "Patient improved post-op"
        },
        {
          id: "MEDU-003",
          title: "Pediatric Fever Evaluation",
          type: "Pediatrics",
          status: "Pending",
          creator: "Dr. Chen",
          assignedTo: "Dr. Chen",
          lastUpdated: "2025-07-01",
          symptoms: "Fever, rash, irritability",
          history: "3-year-old with 2-day history of fever",
          labResults: "CBC normal, CRP elevated",
          diagnosis: "Likely viral exanthem",
          outcome: "Observation recommended",
          notes: "Parents instructed on warning signs"
        }
      ];

      const initialTickets = [
        {
          id: "TCK-001",
          title: "Lab Equipment Issue",
          description: "Malfunctioning centrifuge in lab",
          status: "Open",
          creator: "Dr. Smith",
          lastUpdated: "2025-07-06"
        },
        {
          id: "TCK-002",
          title: "Patient Record Error",
          description: "Incorrect data entry in patient file",
          status: "Resolved",
          creator: "Dr. Lee",
          lastUpdated: "2025-07-04"
        }
      ];

      const initialTasks = [
        {
          id: "TSK-001",
          title: "Review Patient Charts",
          description: "Review charts for upcoming audit",
          status: "Open",
          creator: "Dr. Smith",
          lastUpdated: "2025-07-06",
          rating: 0,
          feedback: ""
        }
      ];

      // State management
      let cases = JSON.parse(localStorage.getItem('cases')) || initialCases;
      let tickets = JSON.parse(localStorage.getItem('tickets')) || initialTickets;
      let tasks = JSON.parse(localStorage.getItem('tasks')) || initialTasks;
      let feedbackList = JSON.parse(localStorage.getItem('feedbackList')) || [];
      let members = JSON.parse(localStorage.getItem('members')) || [];
      let notifications = JSON.parse(localStorage.getItem('notifications')) || [];
      let filteredCases = [...cases];
      let filteredTickets = [...tickets];
      let filteredTasks = [...tasks];
      let currentSort = { col: null, asc: true };
      let user = JSON.parse(localStorage.getItem('user')) || { role: null, name: null };

      // DOM elements
      const app = document.getElementById('app');
      const loginPage = document.getElementById('loginPage');
      const memberLoginPage = document.getElementById('memberLoginPage');
      const content = document.getElementById('content');
      const modal = document.getElementById('itemModal');
      const modalTitle = document.getElementById('modalTitle');
      const modalBody = document.getElementById('modalBody');
      const modalClose = document.getElementById('modalClose');
      const notification = document.getElementById('notification');
      const navLinks = document.querySelectorAll('.nav-link');
      const darkModeToggle = document.getElementById('darkModeToggle');
      const logoutBtn = document.getElementById('logoutBtn');

      // Notification helper
      function showNotification(message, type = 'success') {
        notification.textContent = message;
        notification.className = `notification ${type} active`;
        setTimeout(() => {
          notification.className = 'notification';
        }, 3000);
      }

      // Authentication check
      function checkAuth() {
        if (!user.role) {
          app.style.display = 'none';
          loginPage.style.display = 'block';
          memberLoginPage.style.display = 'none';
          renderAdminLogin();
        } else {
          app.style.display = 'flex';
          loginPage.style.display = 'none';
          memberLoginPage.style.display = 'none';
          updateNavLinks();
          activateSection('dashboard');
        }
      }

      // Update navigation based on user role
      function updateNavLinks() {
        navLinks.forEach(link => {
          const section = link.dataset.section;
          if (user.role === 'member' && (section === 'members' || section === 'feedback')) {
            link.style.display = 'none';
          } else {
            link.style.display = 'block';
          }
        });
      }

      // Admin login
      function renderAdminLogin() {
        const form = loginPage.querySelector('.login-form');
        const errorMessage = document.getElementById('loginError');
        form.addEventListener('submit', e => {
          e.preventDefault();
          const username = form.username.value.trim();
          const password = form.password.value.trim();
          if (username === 'Luna.C.Everly' && password === 'lunamedudirector') {
            user = { role: 'admin', name: 'Luna.C.Everly' };
            localStorage.setItem('user', JSON.stringify(user));
            app.style.display = 'flex';
            loginPage.style.display = 'none';
            updateNavLinks();
            activateSection('dashboard');
            form.reset();
            errorMessage.classList.remove('active');
          } else {
            errorMessage.classList.add('active');
          }
        });
        document.getElementById('switchToMemberLogin').addEventListener('click', e => {
          e.preventDefault();
          loginPage.style.display = 'none';
          memberLoginPage.style.display = 'block';
          renderMemberLogin();
        });
      }

      // Member login
      function renderMemberLogin() {
        const form = memberLoginPage.querySelector('.login-form');
        const errorMessage = document.getElementById('memberLoginError');
        form.addEventListener('submit', e => {
          e.preventDefault();
          const name = form.memberName.value.trim();
          if (!name || members.includes(name)) {
            errorMessage.textContent = members.includes(name) ? 'Name already in use' : 'Please enter a valid name';
            errorMessage.classList.add('active');
            return;
          }
          members.push(name);
          localStorage.setItem('members', JSON.stringify(members));
          user = { role: 'member', name };
          localStorage.setItem('user', JSON.stringify(user));
          app.style.display = 'flex';
          memberLoginPage.style.display = 'none';
          updateNavLinks();
          activateSection('dashboard');
          form.reset();
          errorMessage.classList.remove('active');
        });
        document.getElementById('switchToAdminLogin').addEventListener('click', e => {
          e.preventDefault();
          memberLoginPage.style.display = 'none';
          loginPage.style.display = 'block';
          renderAdminLogin();
        });
      }

      // Logout
      logoutBtn.addEventListener('click', () => {
        user = { role: null, name: null };
        localStorage.setItem('user', JSON.stringify(user));
        app.style.display = 'none';
        loginPage.style.display = 'block';
        renderAdminLogin();
      });

      // Dark mode toggle
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      if (localStorage.getItem('darkMode') === 'true' || (!localStorage.getItem('darkMode') && prefersDark)) {
        document.body.classList.add('dark-mode');
        darkModeToggle.textContent = '☀️ Light Mode';
      }
      darkModeToggle.addEventListener('click', () => {
        document.body.classList.toggle('dark-mode');
        localStorage.setItem('darkMode', document.body.classList.contains('dark-mode') ? 'true' : 'false');
        darkModeToggle.textContent = document.body.classList.contains('dark-mode') ? '☀️ Light Mode' : '🌙 Dark Mode';
      });

      // Calculate performance
      function calculatePerformance(memberName = null) {
        const totalCases = cases.length;
        const completedCases = cases.filter(c => c.status === 'Solved').length;
        const totalTickets = tickets.length;
        const completedTickets = tickets.filter(t => t.status === 'Resolved').length;
        const totalTasks = tasks.length;
        const completedTasks = tasks.filter(t => t.status === 'Completed').length;
        const totalFeedback = feedbackList.length;
        const totalItems = totalCases + totalTickets + totalTasks;
        const completedItems = completedCases + completedTickets + completedTasks;

        if (memberName) {
          const memberCases = cases.filter(c => c.creator === memberName);
          const memberCompletedCases = memberCases.filter(c => c.status === 'Solved').length;
          const memberTickets = tickets.filter(t => t.creator === memberName);
          const memberCompletedTickets = memberTickets.filter(t => t.status === 'Resolved').length;
          const memberTasks = tasks.filter(t => t.creator === memberName);
          const memberCompletedTasks = memberTasks.filter(t => t.status === 'Completed').length;
          const memberFeedback = feedbackList.filter(f => cases.find(c => c.id === f.caseId)?.creator === memberName).length;
          const memberItems = memberCases.length + memberTickets.length + memberTasks.length;
          const memberCompletedItems = memberCompletedCases + memberCompletedTickets + memberCompletedTasks;
          const ratingSum = tasks.filter(t => t.creator === memberName).reduce((sum, t) => sum + t.rating, 0);
          const ratedTasks = tasks.filter(t => t.creator === memberName && t.rating > 0).length;
          const avgRating = ratedTasks ? (ratingSum / ratedTasks).toFixed(1) : 0;
          return {
            completion: memberItems ? Math.round((memberCompletedItems / memberItems) * 100) : 0,
            contributions: memberItems,
            feedback: memberFeedback,
            avgRating
          };
        }

        return {
          overall: totalItems ? Math.round((completedItems / totalItems) * 100) : 0,
          caseCompletion: totalCases ? Math.round((completedCases / totalCases) * 100) : 0,
          ticketCompletion: totalTickets ? Math.round((completedTickets / totalTickets) * 100) : 0,
          taskCompletion: totalTasks ? Math.round((completedTasks / totalTasks) * 100) : 0,
          feedbackCount: totalFeedback
        };
      }

      // Render dashboard
      function renderDashboard() {
        const performance = calculatePerformance();
        const memberPerformance = user.role === 'admin' ? members.map(m => ({
          name: m,
          ...calculatePerformance(m)
        })) : user.role === 'member' ? [{
          name: user.name,
          ...calculatePerformance(user.name)
        }] : [];
        content.innerHTML = `
          <h2>${user.role === 'admin' ? 'Admin' : 'Member'} Dashboard</h2>
          <div class="stats-grid">
            <div class="stat-card">
              <h3>Total Cases</h3>
              <p>${cases.length}</p>
            </div>
            <div class="stat-card">
              <h3>Open Cases</h3>
              <p>${cases.filter(c => c.status === 'Open').length}</p>
            </div>
            <div class="stat-card">
              <h3>Pending Cases</h3>
              <p>${cases.filter(c => c.status === 'Pending').length}</p>
            </div>
            <div class="stat-card">
              <h3>Solved Cases</h3>
              <p>${cases.filter(c => c.status === 'Solved').length}</p>
            </div>
            <div class="stat-card">
              <h3>Total Tickets</h3>
              <p>${tickets.length}</p>
            </div>
            <div class="stat-card">
              <h3>Resolved Tickets</h3>
              <p>${tickets.filter(t => t.status === 'Resolved').length}</p>
            </div>
            <div class="stat-card">
              <h3>Total Tasks</h3>
              <p>${tasks.length}</p>
            </div>
            <div class="stat-card">
              <h3>Completed Tasks</h3>
              <p>${tasks.filter(t => t.status === 'Completed').length}</p>
            </div>
          </div>
          <h3>Overall Performance</h3>
          <div class="progress-bar-container">
            <div class="progress-bar" style="width: ${performance.overall}%">${performance.overall}%</div>
          </div>
          ${user.role === 'admin' || user.role === 'member' ? `
            <h3>${user.role === 'admin' ? 'Member Performance' : 'Your Performance'}</h3>
            ${memberPerformance.map(mp => `
              <div class="stat-card">
                <h3>${mp.name}</h3>
                <p>Completion: ${mp.completion}%</p>
                <p>Contributions: ${mp.contributions}</p>
                <p>Feedback Received: ${mp.feedback}</p>
                <p>Avg Task Rating: ${mp.avgRating}/5</p>
                <div class="progress-bar-container">
                  <div class="progress-bar" style="width: ${mp.completion}%">${mp.completion}%</div>
                </div>
              </div>
            `).join('')}
          ` : ''}
          <h3>Recent Cases</h3>
          <table aria-label="Recent cases table" role="grid" id="casesTable" tabindex="0">
            <thead>
              <tr>
                <th scope="col">Case ID <button class="sort-btn" data-col="id">↑↓</button></th>
                <th scope="col">Title <button class="sort-btn" data-col="title">↑↓</button></th>
                <th scope="col">Type <button class="sort-btn" data-col="type">↑↓</button></th>
                <th scope="col">Status <button class="sort-btn" data-col="status">↑↓</button></th>
              </tr>
            </thead>
            <tbody>
              ${cases.slice(0, 5).map(c => `
                <tr tabindex="0" role="row" data-id="${c.id}" data-type="case">
                  <td data-label="Case ID">${c.id}</td>
                  <td data-label="Title">${c.title}</td>
                  <td data-label="Type">${c.type}</td>
                  <td data-label="Status"><span class="badge ${c.status.toLowerCase()}">${c.status}</span></td>
                </tr>
              `).join('')}
            </tbody>
          </table>
          <h3>Your Notifications</h3>
          <div id="userNotifications">
            ${notifications.filter(n => n.recipient === user.name).map(n => `
              <div class="modal-section">
                <p>${n.message}</p>
                <small>${new Date(n.timestamp).toLocaleString()}</small>
              </div>
            `).join('') || '<p>No notifications.</p>'}
          </div>
        `;
        addTableEventListeners('case');
      }

      // Render case table
      function renderCasesTable() {
        content.innerHTML = `
          <h2>Medical Cases</h2>
          <div class="filters" aria-label="Filter cases">
            <label for="searchInput">Search:
              <input type="search" id="searchInput" placeholder="Search by title or ID" aria-label="Search cases" />
            </label>
            <label for="typeFilter">Type:
              <select id="typeFilter" aria-label="Filter by case type">
                <option value="all">All</option>
                <option value="Ethical">Ethical</option>
                <option value="Emergency">Emergency</option>
                <option value="Pediatrics">Pediatrics</option>
              </select>
            </label>
            <label for="statusFilter">Status:
              <select id="statusFilter" aria-label="Filter by case status">
                <option value="all">All</option>
                <option value="Open">Open</option>
                <option value="Solved">Solved</option>
                <option value="Pending">Pending</option>
              </select>
            </label>
          </div>
          <table aria-label="Cases table" role="grid" id="casesTable" tabindex="0">
            <thead>
              <tr>
                <th scope="col">Case ID <button class="sort-btn" data-col="id">↑↓</button></th>
                <th scope="col">Title <button class="sort-btn" data-col="title">↑↓</button></th>
                <th scope="col">Type <button class="sort-btn" data-col="type">↑↓</button></th>
                <th scope="col">Status <button class="sort-btn" data-col="status">↑↓</button></th>
                <th scope="col">Creator <button class="sort-btn" data-col="creator">↑↓</button></th>
                <th scope="col">Assigned To <button class="sort-btn" data-col="assignedTo">↑↓</button></th>
                <th scope="col">Last Updated <button class="sort-btn" data-col="lastUpdated">↑↓</button></th>
              </tr>
            </thead>
            <tbody>
              ${filteredCases.map(c => `
                <tr tabindex="0" role="row" data-id="${c.id}" data-type="case">
                  <td data-label="Case ID">${c.id}</td>
                  <td data-label="Title">${c.title}</td>
                  <td data-label="Type">${c.type}</td>
                  <td data-label="Status"><span class="badge ${c.status.toLowerCase()}">${c.status}</span></td>
                  <td data-label="Creator">${c.creator}</td>
                  <td data-label="Assigned To">${c.assignedTo}</td>
                  <td data-label="Last Updated">${c.lastUpdated}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
        addTableEventListeners('case');
      }

      // Render tickets table
      function renderTicketsTable() {
        const performance = calculatePerformance();
        content.innerHTML = `
          <h2>Tickets</h2>
          <div class="progress-bar-container">
            <div class="progress-bar" style="width: ${performance.ticketCompletion}%">${performance.ticketCompletion}% Resolved</div>
          </div>
          <div class="filters" aria-label="Filter tickets">
            <label for="ticketSearchInput">Search:
              <input type="search" id="ticketSearchInput" placeholder="Search by title or ID" aria-label="Search tickets" />
            </label>
            <label for="ticketStatusFilter">Status:
              <select id="ticketStatusFilter" aria-label="Filter by ticket status">
                <option value="all">All</option>
                <option value="Open">Open</option>
                <option value="In Progress">In Progress</option>
                <option value="Resolved">Resolved</option>
              </select>
            </label>
          </div>
          <table aria-label="Tickets table" role="grid" id="ticketsTable" tabindex="0">
            <thead>
              <tr>
                <th scope="col">Ticket ID <button class="sort-btn" data-col="id">↑↓</button></th>
                <th scope="col">Title <button class="sort-btn" data-col="title">↑↓</button></th>
                <th scope="col">Status <button class="sort-btn" data-col="status">↑↓</button></th>
                <th scope="col">Creator <button class="sort-btn" data-col="creator">↑↓</button></th>
                <th scope="col">Last Updated <button class="sort-btn" data-col="lastUpdated">↑↓</button></th>
              </tr>
            </thead>
            <tbody>
              ${filteredTickets.map(t => `
                <tr tabindex="0" role="row" data-id="${t.id}" data-type="ticket">
                  <td data-label="Ticket ID">${t.id}</td>
                  <td data-label="Title">${t.title}</td>
                  <td data-label="Status"><span class="badge ${t.status.toLowerCase().replace(' ', '-')}">${t.status}</span></td>
                  <td data-label="Creator">${t.creator}</td>
                  <td data-label="Last Updated">${t.lastUpdated}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
          ${user.role === 'member' ? `
            <h3>Create New Ticket</h3>
            <form class="ticket-form" aria-label="New ticket form">
              <label for="ticketTitle">Ticket Title</label>
              <input type="text" id="ticketTitle" name="ticketTitle" required placeholder="Enter ticket title" maxlength="100" />
              <label for="ticketDescription">Description</label>
              <textarea id="ticketDescription" name="ticketDescription" required placeholder="Describe the issue"></textarea>
              <button type="submit" class="submit-btn">Submit Ticket</button>
            </form>
          ` : ''}
        `;
        addTableEventListeners('ticket');
        if (user.role === 'member') {
          const form = content.querySelector('.ticket-form');
          form.addEventListener('submit', e => {
            e.preventDefault();
            const newTicket = {
              id: `TCK-${(tickets.length + 1).toString().padStart(3, '0')}`,
              title: form.ticketTitle.value.trim(),
              description: form.ticketDescription.value.trim(),
              status: 'Open',
              creator: user.name,
              lastUpdated: new Date().toISOString().split('T')[0]
            };
            if (!newTicket.title || !newTicket.description) {
              showNotification('Please fill in all required fields.', 'error');
              return;
            }
            tickets.push(newTicket);
            localStorage.setItem('tickets', JSON.stringify(tickets));
            filteredTickets = [...tickets];
            form.reset();
            showNotification(`New ticket ${newTicket.id} added!`);
            renderTicketsTable();
          });
        }
      }

      // Render tasks table
      function renderTasksTable() {
        content.innerHTML = `
          <h2>Tasks</h2>
          <div class="filters" aria-label="Filter tasks">
            <label for="taskSearchInput">Search:
              <input type="search" id="taskSearchInput" placeholder="Search by title or ID" aria-label="Search tasks" />
            </label>
            <label for="taskStatusFilter">Status:
              <select id="taskStatusFilter" aria-label="Filter by task status">
                <option value="all">All</option>
                <option value="Open">Open</option>
                <option value="Completed">Completed</option>
              </select>
            </label>
          </div>
          <table aria-label="Tasks table" role="grid" id="tasksTable" tabindex="0">
            <thead>
              <tr>
                <th scope="col">Task ID <button class="sort-btn" data-col="id">↑↓</button></th>
                <th scope="col">Title <button class="sort-btn" data-col="title">↑↓</button></th>
                <th scope="col">Status <button class="sort-btn" data-col="status">↑↓</button></th>
                <th scope="col">Creator <button class="sort-btn" data-col="creator">↑↓</button></th>
                <th scope="col">Rating</th>
                <th scope="col">Last Updated <button class="sort-btn" data-col="lastUpdated">↑↓</button></th>
              </tr>
            </thead>
            <tbody>
              ${filteredTasks.map(t => `
                <tr tabindex="0" role="row" data-id="${t.id}" data-type="task">
                  <td data-label="Task ID">${t.id}</td>
                  <td data-label="Title">${t.title}</td>
                  <td data-label="Status"><span class="badge ${t.status.toLowerCase()}">${t.status}</span></td>
                  <td data-label="Creator">${t.creator}</td>
                  <td data-label="Rating">${'★'.repeat(t.rating)}${'☆'.repeat(5 - t.rating)}</td>
                  <td data-label="Last Updated">${t.lastUpdated}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
          ${user.role === 'member' ? `
            <h3>Create New Task</h3>
            <form class="task-form" aria-label="New task form">
              <label for="taskTitle">Task Title</label>
              <input type="text" id="taskTitle" name="taskTitle" required placeholder="Enter task title" maxlength="100" />
              <label for="taskDescription">Description</label>
              <textarea id="taskDescription" name="taskDescription" required placeholder="Describe the task"></textarea>
              <button type="submit" class="submit-btn">Submit Task</button>
            </form>
          ` : ''}
        `;
        addTableEventListeners('task');
        if (user.role === 'member') {
          const form = content.querySelector('.task-form');
          form.addEventListener('submit', e => {
            e.preventDefault();
            const newTask = {
              id: `TSK-${(tasks.length + 1).toString().padStart(3, '0')}`,
              title: form.taskTitle.value.trim(),
              description: form.taskDescription.value.trim(),
              status: 'Open',
              creator: user.name,
              lastUpdated: new Date().toISOString().split('T')[0],
              rating: 0,
              feedback: ''
            };
            if (!newTask.title || !newTask.description) {
              showNotification('Please fill in all required fields.', 'error');
              return;
            }
            tasks.push(newTask);
            localStorage.setItem('tasks', JSON.stringify(tasks));
            filteredTasks = [...tasks];
            form.reset();
            showNotification(`New task ${newTask.id} added!`);
            renderTasksTable();
          });
        }
      }

      // Add table event listeners
      function addTableEventListeners(type) {
        const sortButtons = document.querySelectorAll('.sort-btn');
        sortButtons.forEach(btn => {
          btn.addEventListener('click', () => {
            currentSort.col = btn.dataset.col;
            currentSort.asc = currentSort.col === btn.dataset.col ? !currentSort.asc : true;
            if (type === 'case') sortCases();
            else if (type === 'ticket') sortTickets();
            else if (type === 'task') sortTasks();
            if (type === 'case') renderCasesTable();
            else if (type === 'ticket') renderTicketsTable();
            else if (type === 'task') renderTasksTable();
          });
        });
        if (type === 'case') {
          document.getElementById('searchInput')?.addEventListener('input', applyCaseFilters);
          document.getElementById('typeFilter')?.addEventListener('change', applyCaseFilters);
          document.getElementById('statusFilter')?.addEventListener('change', applyCaseFilters);
        } else if (type === 'ticket') {
          document.getElementById('ticketSearchInput')?.addEventListener('input', applyTicketFilters);
          document.getElementById('ticketStatusFilter')?.addEventListener('change', applyTicketFilters);
        } else if (type === 'task') {
          document.getElementById('taskSearchInput')?.addEventListener('input', applyTaskFilters);
          document.getElementById('taskStatusFilter')?.addEventListener('change', applyTaskFilters);
        }
        document.querySelectorAll(`#${type}sTable tbody tr`).forEach(row => {
          row.addEventListener('click', () => openItemModal(row.dataset.id, row.dataset.type));
          row.addEventListener('keypress', e => {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              openItemModal(row.dataset.id, row.dataset.type);
            }
          });
        });
      }

      // Sort functions
      function sortCases() {
        if (!currentSort.col) return;
        filteredCases.sort((a, b) => {
          let valA = a[currentSort.col];
          let valB = b[currentSort.col];
          if (currentSort.col === 'lastUpdated') {
            valA = new Date(valA);
            valB = new Date(valB);
          } else {
            valA = valA.toString().toLowerCase();
            valB = valB.toString().toLowerCase();
          }
          return currentSort.asc ? (valA < valB ? -1 : 1) : (valA < valB ? 1 : -1);
        });
      }

      function sortTickets() {
        if (!currentSort.col) return;
        filteredTickets.sort((a, b) => {
          let valA = a[currentSort.col];
          let valB = b[currentSort.col];
          if (currentSort.col === 'lastUpdated') {
            valA = new Date(valA);
            valB = new Date(valB);
          } else {
            valA = valA.toString().toLowerCase();
            valB = valB.toString().toLowerCase();
          }
          return currentSort.asc ? (valA < valB ? -1 : 1) : (valA < valB ? 1 : -1);
        });
      }

      function sortTasks() {
        if (!currentSort.col) return;
        filteredTasks.sort((a, b) => {
          let valA = a[currentSort.col];
          let valB = b[currentSort.col];
          if (currentSort.col === 'lastUpdated') {
            valA = new Date(valA);
            valB = new Date(valB);
          } else {
            valA = valA.toString().toLowerCase();
            valB = valB.toString().toLowerCase();
          }
          return currentSort.asc ? (valA < valB ? -1 : 1) : (valA < valB ? 1 : -1);
        });
      }

      // Apply filters
      function applyCaseFilters() {
        const searchVal = document.getElementById('searchInput')?.value.toLowerCase() || '';
        const typeVal = document.getElementById('typeFilter')?.value || 'all';
        const statusVal = document.getElementById('statusFilter')?.value || 'all';
        filteredCases = cases.filter(c => {
          const matchesSearch = c.title.toLowerCase().includes(searchVal) || c.id.toLowerCase().includes(searchVal);
          const matchesType = typeVal === 'all' || c.type === typeVal;
          const matchesStatus = statusVal === 'all' || c.status === statusVal;
          return matchesSearch && matchesType && matchesStatus;
        });
        sortCases();
        renderCasesTable();
      }

      function applyTicketFilters() {
        const searchVal = document.getElementById('ticketSearchInput')?.value.toLowerCase() || '';
        const statusVal = document.getElementById('ticketStatusFilter')?.value || 'all';
        filteredTickets = tickets.filter(t => {
          const matchesSearch = t.title.toLowerCase().includes(searchVal) || t.id.toLowerCase().includes(searchVal);
          const matchesStatus = statusVal === 'all' || t.status === statusVal;
          return matchesSearch && matchesStatus;
        });
        sortTickets();
        renderTicketsTable();
      }

      function applyTaskFilters() {
        const searchVal = document.getElementById('taskSearchInput')?.value.toLowerCase() || '';
        const statusVal = document.getElementById('taskStatusFilter')?.value || 'all';
        filteredTasks = tasks.filter(t => {
          const matchesSearch = t.title.toLowerCase().includes(searchVal) || t.id.toLowerCase().includes(searchVal);
          const matchesStatus = statusVal === 'all' || t.status === statusVal;
          return matchesSearch && matchesStatus;
        });
        sortTasks();
        renderTasksTable();
      }

      // Open item modal (case/ticket/task)
      function openItemModal(id, type, editMode = false) {
        let item, titlePrefix, dataFields;
        if (type === 'case') {
          item = cases.find(c => c.id === id);
          titlePrefix = 'Case';
          dataFields = ['symptoms', 'history', 'labResults', 'diagnosis', 'outcome', 'notes'];
        } else if (type === 'ticket') {
          item = tickets.find(t => t.id === id);
          titlePrefix = 'Ticket';
          dataFields = ['description'];
        } else if (type === 'task') {
          item = tasks.find(t => t.id === id);
          titlePrefix = 'Task';
          dataFields = ['description', 'feedback'];
        }
        if (!item) return;

        modalTitle.textContent = editMode ? `Edit ${titlePrefix}: ${item.id}` : `${titlePrefix}: ${item.id} - ${item.title}`;
        if (editMode && user.role === 'admin') {
          if (type === 'case') {
            modalBody.innerHTML = `
              <form class="edit-case-form" aria-label="Edit case form">
                <label for="editTitle">Case Title</label>
                <input type="text" id="editTitle" name="title" value="${item.title}" required maxlength="100" />
                <label for="editType">Case Type</label>
                <select id="editType" name="type" required>
                  <option value="Ethical" ${item.type === 'Ethical' ? 'selected' : ''}>Ethical</option>
                  <option value="Emergency" ${item.type === 'Emergency' ? 'selected' : ''}>Emergency</option>
                  <option value="Pediatrics" ${item.type === 'Pediatrics' ? 'selected' : ''}>Pediatrics</option>
                </select>
                <label for="editStatus">Status</label>
                <select id="editStatus" name="status" required>
                  <option value="Open" ${item.status === 'Open' ? 'selected' : ''}>Open</option>
                  <option value="Pending" ${item.status === 'Pending' ? 'selected' : ''}>Pending</option>
                  <option value="Solved" ${item.status === 'Solved' ? 'selected' : ''}>Solved</option>
                </select>
                <label for="editAssignedTo">Assigned To</label>
                <input type="text" id="editAssignedTo" name="assignedTo" value="${item.assignedTo}" required maxlength="50" />
                <label for="editSymptoms">Symptoms</label>
                <textarea id="editSymptoms" name="symptoms" required>${item.symptoms}</textarea>
                <label for="editHistory">History</label>
                <textarea id="editHistory" name="history" required>${item.history}</textarea>
                <label for="editLabResults">Lab Results</label>
                <textarea id="editLabResults" name="labResults">${item.labResults}</textarea>
                <label for="editDiagnosis">Diagnosis</label>
                <textarea id="editDiagnosis" name="diagnosis">${item.diagnosis}</textarea>
                <label for="editOutcome">Outcome</label>
                <textarea id="editOutcome" name="outcome">${item.outcome}</textarea>
                <label for="editNotes">Notes</label>
                <textarea id="editNotes" name="notes">${item.notes}</textarea>
                <div style="display: flex; gap: 1rem;">
                  <button type="submit" class="submit-btn">Save Changes</button>
                  <button type="button" class="submit-btn" id="deleteItemBtn">Delete Case</button>
                </div>
              </form>
            `;
          } else if (type === 'ticket') {
            modalBody.innerHTML = `
              <form class="edit-ticket-form" aria-label="Edit ticket form">
                <label for="editTitle">Ticket Title</label>
                <input type="text" id="editTitle" name="title" value="${item.title}" required maxlength="100" />
                <label for="editDescription">Description</label>
                <textarea id="editDescription" name="description" required>${item.description}</textarea>
                <label for="editStatus">Status</label>
                <select id="editStatus" name="status" required>
                  <option value="Open" ${item.status === 'Open' ? 'selected' : ''}>Open</option>
                  <option value="In Progress" ${item.status === 'In Progress' ? 'selected' : ''}>In Progress</option>
                  <option value="Resolved" ${item.status === 'Resolved' ? 'selected' : ''}>Resolved</option>
                </select>
                <div style="display: flex; gap: 1rem;">
                  <button type="submit" class="submit-btn">Save Changes</button>
                  <button type="button" class="submit-btn" id="deleteItemBtn">Delete Ticket</button>
                </div>
              </form>
            `;
          } else if (type === 'task') {
            modalBody.innerHTML = `
              <form class="edit-task-form" aria-label="Edit task form">
                <label for="editTitle">Task Title</label>
                <input type="text" id="editTitle" name="title" value="${item.title}" required maxlength="100" />
                <label for="editDescription">Description</label>
                <textarea id="editDescription" name="description" required>${item.description}</textarea>
                <label for="editStatus">Status</label>
                <select id="editStatus" name="status" required>
                  <option value="Open" ${item.status === 'Open' ? 'selected' : ''}>Open</option>
                  <option value="Completed" ${item.status === 'Completed' ? 'selected' : ''}>Completed</option>
                </select>
                <label for="editRating">Rating</label>
                <div class="star-rating">
                  ${[1, 2, 3, 4, 5].map(i => `
                    <input type="radio" id="rating${i}" name="rating" value="${i}" ${item.rating === i ? 'checked' : ''}>
                    <label for="rating${i}">★</label>
                  `).join('')}
                </div>
                <label for="editFeedback">Feedback</label>
                <textarea id="editFeedback" name="feedback">${item.feedback}</textarea>
                <div style="display: flex; gap: 1rem;">
                  <button type="submit" class="submit-btn">Save Changes</button>
                  <button type="button" class="submit-btn" id="deleteItemBtn">Delete Task</button>
                </div>
              </form>
            `;
          }
          const form = modalBody.querySelector(`.edit-${type}-form`);
          form.addEventListener('submit', e => {
            e.preventDefault();
            const updatedItem = {
              id: item.id,
              title: form.title.value.trim(),
              status: form.status.value,
              lastUpdated: new Date().toISOString().split('T')[0],
              creator: item.creator
            };
            if (type === 'case') {
              updatedItem.type = form.type.value;
              updatedItem.assignedTo = form.assignedTo.value.trim();
              updatedItem.symptoms = form.symptoms.value.trim();
              updatedItem.history = form.history.value.trim();
              updatedItem.labResults = form.labResults.value.trim();
              updatedItem.diagnosis = form.diagnosis.value.trim();
              updatedItem.outcome = form.outcome.value.trim();
              updatedItem.notes = form.notes.value.trim();
              if (!updatedItem.title || !updatedItem.type || !updatedItem.assignedTo || !updatedItem.symptoms || !updatedItem.history) {
                showNotification('Please fill in all required fields.', 'error');
                return;
              }
              cases = cases.map(c => c.id === item.id ? updatedItem : c);
              localStorage.setItem('cases', JSON.stringify(cases));
              filteredCases = [...cases];
            } else if (type === 'ticket') {
              updatedItem.description = form.description.value.trim();
              if (!updatedItem.title || !updatedItem.description) {
                showNotification('Please fill in all required fields.', 'error');
                return;
              }
              tickets = tickets.map(t => t.id === item.id ? updatedItem : t);
              localStorage.setItem('tickets', JSON.stringify(tickets));
              filteredTickets = [...tickets];
            } else if (type === 'task') {
              updatedItem.description = form.description.value.trim();
              updatedItem.rating = parseInt(form.rating.value || '0');
              updatedItem.feedback = form.feedback.value.trim();
              if (!updatedItem.title || !updatedItem.description) {
                showNotification('Please fill in all required fields.', 'error');
                return;
              }
              tasks = tasks.map(t => t.id === item.id ? updatedItem : t);
              localStorage.setItem('tasks', JSON.stringify(tasks));
              filteredTasks = [...tasks];
            }
            modal.classList.remove('active');
            modal.setAttribute('aria-hidden', 'true');
            showNotification(`${titlePrefix} updated successfully!`);
            activateSection(type === 'case' ? 'cases' : type === 'ticket' ? 'tickets' : 'tasks');
          });
          document.getElementById('deleteItemBtn').addEventListener('click', () => {
            if (confirm(`Are you sure you want to delete ${titlePrefix.toLowerCase()} ${item.id}?`)) {
              if (type === 'case') {
                cases = cases.filter(c => c.id !== item.id);
                feedbackList = feedbackList.filter(f => f.caseId !== item.id);
                localStorage.setItem('cases', JSON.stringify(cases));
                localStorage.setItem('feedbackList', JSON.stringify(feedbackList));
                filteredCases = [...cases];
              } else if (type === 'ticket') {
                tickets = tickets.filter(t => t.id !== item.id);
                localStorage.setItem('tickets', JSON.stringify(tickets));
                filteredTickets = [...tickets];
              } else if (type === 'task') {
                tasks = tasks.filter(t => t.id !== item.id);
                localStorage.setItem('tasks', JSON.stringify(tasks));
                filteredTasks = [...tasks];
              }
              modal.classList.remove('active');
              modal.setAttribute('aria-hidden', 'true');
              showNotification(`${titlePrefix} deleted successfully!`);
              activateSection(type === 'case' ? 'cases' : type === 'ticket' ? 'tickets' : 'tasks');
            }
          });
        } else {
          modalBody.innerHTML = `
            ${dataFields.map(field => `
              <div class="modal-section">
                <h3>${field.charAt(0).toUpperCase() + field.slice(1)}</h3>
                <p>${item[field] || 'N/A'}</p>
              </div>
            `).join('')}
            ${type === 'task' && item.rating > 0 ? `
              <div class="modal-section">
                <h3>Rating</h3>
                <p>${'★'.repeat(item.rating)}${'☆'.repeat(5 - item.rating)}</p>
              </div>
            ` : ''}
            ${type === 'case' && user.role === 'admin' ? `
              <button class="submit-btn" id="editItemBtn" style="margin-bottom: 1rem;">Edit Case</button>
              <form class="feedback-form" aria-label="Case feedback form">
                <label for="feedbackText">Submit Feedback</label>
                <textarea id="feedbackText" name="feedbackText" rows="4" required placeholder="Enter your feedback..."></textarea>
                <button type="submit" class="submit-btn">Submit Feedback</button>
              </form>
            ` : ''}
          `;
          if (type === 'case' && user.role === 'admin') {
            document.getElementById('editItemBtn').addEventListener('click', () => openItemModal(id, type, true));
            const feedbackForm = modalBody.querySelector('.feedback-form');
            feedbackForm.addEventListener('submit', e => {
              e.preventDefault();
              const feedbackText = feedbackForm.feedbackText.value.trim();
              if (!feedbackText) {
                showNotification('Feedback cannot be empty.', 'error');
                return;
              }
              feedbackList.push({
                caseId: item.id,
                feedback: feedbackText,
                timestamp: new Date().toISOString()
              });
              localStorage.setItem('feedbackList', JSON.stringify(feedbackList));
              notifications.push({
                recipient: item.creator,
                message: `New feedback on case ${item.id}: ${feedbackText.substring(0, 50)}${feedbackText.length > 50 ? '...' : ''}`,
                timestamp: new Date().toISOString()
              });
              localStorage.setItem('notifications', JSON.stringify(notifications));
              feedbackForm.reset();
              showNotification('Feedback submitted successfully!');
              if (user.name === item.creator) {
                renderDashboard();
              }
            });
          } else if ((type === 'ticket' || type === 'task') && user.role === 'admin') {
            modalBody.innerHTML += `
              <button class="submit-btn" id="editItemBtn" style="margin-bottom: 1rem;">Edit ${titlePrefix}</button>
            `;
            document.getElementById('editItemBtn').addEventListener('click', () => openItemModal(id, type, true));
          }
        }
        modal.classList.add('active');
        modal.setAttribute('aria-hidden', 'false');
      }

      // Close modal
      modalClose.addEventListener('click', closeModal);
      modal.addEventListener('click', e => {
        if (e.target === modal) closeModal();
      });
      document.addEventListener('keydown', e => {
        if (e.key === 'Escape' && modal.classList.contains('active')) closeModal();
      });
      function closeModal() {
        modal.classList.remove('active');
        modal.setAttribute('aria-hidden', 'true');
      }

      // Render new case form
      function renderNewCaseForm() {
        content.innerHTML = `
          <h2>Submit New Medical Case</h2>
          <form class="new-case-form" aria-label="New medical case submission form">
            <label for="caseTitle">Case Title</label>
            <input type="text" id="caseTitle" name="caseTitle" required placeholder="Enter case title" maxlength="100" />
            <label for="caseType">Case Type</label>
            <select id="caseType" name="caseType" required>
              <option value="" disabled selected>Select type</option>
              <option value="Ethical">Ethical</option>
              <option value="Emergency">Emergency</option>
              <option value="Pediatrics">Pediatrics</option>
            </select>
            <label for="caseAssignedTo">Assigned To</label>
            <input type="text" id="caseAssignedTo" name="caseAssignedTo" required placeholder="Enter assignee (e.g., Dr. Smith)" maxlength="50" />
            <label for="caseSymptoms">Symptoms</label>
            <textarea id="caseSymptoms" name="caseSymptoms" rows="3" required placeholder="Describe symptoms"></textarea>
            <label for="caseHistory">History</label>
            <textarea id="caseHistory" name="caseHistory" rows="4" required placeholder="Patient history"></textarea>
            <label for="caseLabResults">Lab Results</label>
            <textarea id="caseLabResults" name="caseLabResults" rows="3" placeholder="Lab results (optional)"></textarea>
            <label for="caseDiagnosis">Diagnosis</label>
            <textarea id="caseDiagnosis" name="caseDiagnosis" rows="3" placeholder="Diagnosis (optional)"></textarea>
            <label for="caseOutcome">Outcome</label>
            <textarea id="caseOutcome" name="caseOutcome" rows="3" placeholder="Outcome (optional)"></textarea>
            <button type="submit" class="submit-btn">Submit Case</button>
          </form>        `;
        const form = content.querySelector('.new-case-form');
        form.addEventListener('submit', e => {
          e.preventDefault();
          const newCase = {
            id: `MEDU-${(cases.length + 1).toString().padStart(3, '0')}`,
            title: form.caseTitle.value.trim(),
            type: form.caseType.value,
            status: 'Open',
            creator: user.name,
            assignedTo: form.caseAssignedTo.value.trim(),
            lastUpdated: new Date().toISOString().split('T')[0],
            symptoms: form.caseSymptoms.value.trim(),
            history: form.caseHistory.value.trim(),
            labResults: form.caseLabResults.value.trim(),
            diagnosis: form.caseDiagnosis.value.trim(),
            outcome: form.caseOutcome.value.trim(),
            notes: ''
          };
          if (!newCase.title || !newCase.type || !newCase.assignedTo || !newCase.symptoms || !newCase.history) {
            showNotification('Please fill in all required fields.', 'error');
            return;
          }
          cases.push(newCase);
          localStorage.setItem('cases', JSON.stringify(cases));
          filteredCases = [...cases];
          form.reset();
          showNotification(`New case ${newCase.id} added!`);
          activateSection('cases');
        });
      }

      // Render feedback section
      function renderFeedback() {
        content.innerHTML = `
          <h2>Case Feedback</h2>
          <div class="filters">
            <label for="feedbackCaseFilter">Filter by Case:
              <select id="feedbackCaseFilter">
                <option value="all">All Cases</option>
                ${cases.map(c => `<option value="${c.id}">${c.id} - ${c.title}</option>`).join('')}
              </select>
            </label>
          </div>
          <div id="feedbackList">
            ${feedbackList.length ? feedbackList.filter(f => document.getElementById('feedbackCaseFilter')?.value === 'all' || f.caseId === document.getElementById('feedbackCaseFilter')?.value)
              .map(f => `
                <div class="modal-section">
                  <h3>Case: ${cases.find(c => c.id === f.caseId)?.title || f.caseId}</h3>
                  <p>${f.feedback}</p>
                  <small>Submitted: ${new Date(f.timestamp).toLocaleString()}</small>
                </div>
              `).join('') : '<p>No feedback available.</p>'}
          </div>
        `;
        document.getElementById('feedbackCaseFilter')?.addEventListener('change', renderFeedback);
      }

      // Render members section (admin only)
      function renderMembers() {
        const memberPerformance = members.map(m => ({
          name: m,
          ...calculatePerformance(m)
        }));
        content.innerHTML = `
          <h2>Team Members</h2>
          <div class="stats-grid">
            ${memberPerformance.map(mp => `
              <div class="stat-card">
                <h3>${mp.name}</h3>
                <p>Completion: ${mp.completion}%</p>
                <p>Contributions: ${mp.contributions}</p>
                <p>Feedback Received: ${mp.feedback}</p>
                <p>Avg Task Rating: ${mp.avgRating}/5</p>
                <div class="progress-bar-container">
                  <div class="progress-bar" style="width: ${mp.completion}%">${mp.completion}%</div>
                </div>
              </div>
            `).join('')}
          </div>
        `;
      }

      // Render about section
      function renderAbout() {
        content.innerHTML = `
          <h2>About MEDU Case Vault</h2>
          <p>Welcome to the MEDU Case Vault, a curated collection of medical case studies, tickets, and tasks designed for clinical learning and roleplay by the Medical Education Department.</p>
          <p>Admins can manage cases, tickets, tasks, and provide feedback, while members can contribute cases, tickets, and tasks, and view their performance metrics.</p>
          <p>Features include case management, ticket tracking, task assignment with ratings, feedback notifications, and performance tracking.</p>
          <p>Developed by Luna.C.Everly with emphasis on UX, accessibility, and immersive medical education.</p>
        `;
      }

      // Navigation
      navLinks.forEach(link => {
        link.addEventListener('click', e => {
          e.preventDefault();
          activateSection(link.dataset.section);
        });
      });

      // Activate section
      function activateSection(section) {
        navLinks.forEach(link => link.classList.toggle('active', link.dataset.section === section));
        filteredCases = [...cases];
        filteredTickets = [...tickets];
        filteredTasks = [...tasks];
        sortCases();
        sortTickets();
        sortTasks();
        switch (section) {
          case 'dashboard':
            renderDashboard();
            break;
          case 'cases':
            renderCasesTable();
            break;
          case 'newcase':
            renderNewCaseForm();
            break;
          case 'tickets':
            renderTicketsTable();
            break;
          case 'tasks':
            renderTasksTable();
            break;
          case 'feedback':
            renderFeedback();
            break;
          case 'members':
            if (user.role === 'admin') renderMembers();
            else activateSection('dashboard');
            break;
          case 'about':
            renderAbout();
            break;
          default:
            content.innerHTML = '<p>Section not found.</p>';
        }
      }

      // Initialize
      checkAuth();
    })();
  </script>
</body>
</html>
